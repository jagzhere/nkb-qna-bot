<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naam Jap Counter - NKB QnA Bot</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYD75PMBK3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      gtag('config', 'G-NYD75PMBK3', {
        send_page_view: true
      });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFF8E7 0%, #FFF4E6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        /* Header */
        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #7A0019;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            color: #5A0013;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* Navigation - Single Back Button */
        .nav-buttons {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 12px 20px;
            background: #FF6A00;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: #E55A00;
            transform: translateY(-2px);
        }

        /* Session Selection */
        .session-selection {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(122, 0, 25, 0.1);
            border: 3px solid #FFF4E6;
        }

        .session-title {
            color: #7A0019;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .audio-info {
            background: linear-gradient(135deg, #FFF8E7 0%, white 100%);
            border: 2px solid #FF6A00;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            color: #7A0019;
        }

        .audio-info-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .audio-details {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .session-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .session-option {
            background: linear-gradient(135deg, #FF6A00 0%, #FF4500 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
        }

        .session-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 106, 0, 0.3);
        }

        .session-option.selected {
            background: linear-gradient(135deg, #7A0019 0%, #5A0013 100%);
            border: 3px solid #FFD700;
        }

        .option-count {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .option-duration {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .calculated-time {
            font-size: 0.8rem;
            color: #FFD700;
            font-style: italic;
        }

        /* Practice Session */
        .practice-session {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(122, 0, 25, 0.1);
            border: 3px solid #FFF4E6;
            display: none;
        }

        .practice-session.active {
            display: block;
        }

        /* Image Slideshow */
        .image-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 500px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #7A0019, #5A0013);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slideshow-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .slideshow-image.active {
            opacity: 1;
        }

        .image-loading {
            color: white;
            font-size: 1.2rem;
            display: none;
        }

        .image-loading.show {
            display: block;
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 20px;
            text-align: center;
            z-index: 10;
        }

        .maharaj-blessing {
            font-size: 1.1rem;
            font-weight: 500;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        /* Counter Display */
        .counter-display {
            background: linear-gradient(135deg, #7A0019 0%, #5A0013 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .counter-item {
            text-align: center;
        }

        .counter-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            display: block;
            margin-bottom: 5px;
        }

        .counter-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #FFD700 0%, #FF6A00 100%);
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Audio Controls */
        .audio-section {
            background: linear-gradient(135deg, #FF6A00 0%, #FF4500 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .primary-btn {
            background: white;
            color: #FF6A00;
        }

        .primary-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 100px;
        }

        .audio-status {
            text-align: center;
            font-size: 0.9rem;
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Session Complete */
        .session-complete {
            background: linear-gradient(135deg, #FFD700 0%, #FF6A00 100%);
            color: #7A0019;
            border-radius: 15px;
            padding: 25px;
            display: none;
            text-align: center;
        }

        .session-complete.show {
            display: block;
        }

        .complete-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .complete-message {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .complete-stats {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7A0019;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #5A0013;
            opacity: 0.8;
        }

        /* Footer */
        .footer {
            margin-top: 50px;
            padding: 30px 20px;
            border-top: 1px solid rgba(122, 0, 25, 0.1);
            background: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #5A0013;
        }

        .instagram-link {
            color: #FF6A00;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .instagram-link:hover {
            color: #E55A00;
            text-decoration: underline;
        }

        .instagram-icon {
            font-size: 1.1rem;
        }

        .divider {
            color: #7A0019;
            font-weight: bold;
        }

        .made-with {
            color: #7A0019;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .session-options {
                grid-template-columns: 1fr;
            }

            .counter-display {
                grid-template-columns: repeat(2, 1fr);
            }

            .counter-number {
                font-size: 2rem;
            }

            .image-container {
                height: 400px;
            }

            .audio-controls {
                gap: 10px;
            }

            .control-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .footer-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .divider {
                display: none;
            }
        }

        /* Animations */
        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .celebrating {
            animation: celebration 0.5s ease-in-out 3;
        }

        .fade-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Navigation - Single Back Button -->
        <div class="nav-buttons">
            <a href="index.html" class="nav-btn">← Back to QnA</a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>🙏 Naam Jap Counter</h1>
            <p>Follow Maharaj-ji's divine presence with sacred chanting and imagery</p>
        </div>

        <!-- Session Selection -->
        <div class="session-selection" id="sessionSelection">
            <div class="session-title">🎵 Choose Your Guided Practice</div>
            
            <div class="audio-info">
                <div class="audio-info-title">🎙️ Audio Details</div>
                <div class="audio-details">
                    Chant with Maharajji • Just maintain His speed • The audio adjusts with your chosen session
                </div>
            </div>

            <div class="session-options">
                <button class="session-option" data-count="108" data-duration="1.3">
                    <span class="option-count">108</span>
                    <span class="option-duration">Ram Ram</span>
                    <div class="calculated-time">≈ 1.3 minutes</div>
                </button>
                <button class="session-option" data-count="216" data-duration="2.5">
                    <span class="option-count">216</span>
                    <span class="option-duration">Ram Ram</span>
                    <div class="calculated-time">≈ 2.5 minutes</div>
                </button>
                <button class="session-option" data-count="500" data-duration="5.9">
                    <span class="option-count">500</span>
                    <span class="option-duration">Ram Ram</span>
                    <div class="calculated-time">≈ 5.9 minutes</div>
                </button>
                <button class="session-option" data-count="1008" data-duration="11.9">
                    <span class="option-count">1008</span>
                    <span class="option-duration">Ram Ram</span>
                    <div class="calculated-time">≈ 11.9 minutes</div>
                </button>
            </div>
            
            <button class="nav-btn" id="startPractice" style="opacity: 0.5; pointer-events: none;">
                🙏 Start Guided Practice
            </button>
        </div>

        <!-- Practice Session -->
        <div class="practice-session" id="practiceSession">
            <!-- Image Slideshow -->
            <div class="image-container">
                <div class="image-loading show" id="imageLoading">🙏 Loading Maharaj-ji's divine presence...</div>
                <img class="slideshow-image" id="currentImage" alt="Neem Karoli Baba" style="display: none;">
                <div class="image-overlay">
                    <div class="maharaj-blessing" id="blessingText">🙏 Ram Ram - Maharaj-ji's blessings are with you</div>
                </div>
            </div>

            <!-- Counter Display -->
            <div class="counter-display">
                <div class="counter-item">
                    <span class="counter-number" id="currentCount">0</span>
                    <span class="counter-label">Current Count</span>
                </div>
                <div class="counter-item">
                    <span class="counter-number" id="targetCount">108</span>
                    <span class="counter-label">Target</span>
                </div>
                <div class="counter-item">
                    <span class="counter-number" id="remainingCount">108</span>
                    <span class="counter-label">Remaining</span>
                </div>
                <div class="counter-item">
                    <span class="counter-number" id="sessionTime">0:00</span>
                    <span class="counter-label">Time Elapsed</span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Audio Controls -->
            <div class="audio-section">
                <div class="audio-controls">
                    <button class="control-btn primary-btn" id="playPauseBtn">▶ Start Practice</button>
                    <button class="control-btn secondary-btn" id="resetBtn">🔄 Reset</button>
                    <button class="control-btn secondary-btn" id="completeBtn">✓ Complete Now</button>
                    
                    <div class="volume-control">
                        <span>🔊</span>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="0.7">
                    </div>
                </div>
                <div class="audio-status" id="audioStatus">
                    🎵 Ready to start - audio will loop automatically for your session
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="nav-btn" id="backToSelection">← Choose Different Session</button>
            </div>
        </div>

        <!-- Session Complete -->
        <div class="session-complete" id="sessionComplete">
            <div class="complete-title">🎉 Practice Complete!</div>
            <div class="complete-message">
                Maharaj-ji's blessings have filled your heart. Your devotional practice has been recorded with love.
            </div>
            
            <div class="complete-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="completedCount">108</span>
                        <span class="stat-label">Ram Ram Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="actualDuration">1:18</span>
                        <span class="stat-label">Practice Duration</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="todayTotal">324</span>
                        <span class="stat-label">Today's Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="overallTotal">2,156</span>
                        <span class="stat-label">Lifetime Total</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="nav-btn" id="anotherSession">🙏 Another Session</button>
                <button class="nav-btn" id="shareProgress" style="background: #7A0019;">📱 Share Progress</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                <a href="https://instagram.com/omnipresent.divinity" target="_blank" class="instagram-link">
                    <span class="instagram-icon">📸</span>
                    @omnipresent.divinity
                </a>
                <span class="divider">•</span>
                <span class="made-with">
                    Made with HTML + Javascript + Maharajji's boundless love 💚
                </span>
            </div>
        </div>

        <!-- Hidden Audio Element -->
        <audio id="ramRamAudio" preload="auto" loop>
            <source src="Ram-Ram-Audio-9min52sec.mp4" type="video/mp4">
            <source src="Ram-Ram-Audio-9min52sec.wav" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    </div>

    <script>
        // Google Analytics 4 Enhanced Tracking
        function trackGA4Event(eventName, parameters = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, {
                    event_category: 'nkb_qna',
                    page_title: 'Naam Jap Counter',
                    ...parameters
                });
                console.log(`GA4 Event: ${eventName}`, parameters);
            }
        }

        class NaamJapCounter {
            constructor() {
                // Constants
                this.RAM_RAM_PACE = 85; // Ram Ram per minute in your audio
                this.AUDIO_DURATION_MINUTES = 9.87; // 9 minutes 52 seconds
                this.TOTAL_IMAGES = 168; // Total Baba images available
                
                // Session state
                this.selectedSession = null;
                this.isPlaying = false;
                this.startTime = null;
                this.pausedTime = 0;
                this.currentCount = 0;
                this.targetCount = 108;
                
                // Intervals
                this.countingInterval = null;
                this.imageChangeTimeout = null;
                this.sessionCompleteTimeout = null;
                
                // Image management
                this.currentImageIndex = 0;
                this.usedImages = new Set();
                this.isLoadingImage = false;
                
                // Data
                this.sessionData = this.loadSessionData();
                
                this.blessings = [
                    "🙏 Ram Ram - Maharaj-ji's love surrounds you",
                    "✨ Feel the divine presence in each chant",
                    "🌸 Your devotion is blossoming beautifully",
                    "💐 Maharaj-ji's grace flows through you",
                    "🕉️ Each Ram Ram brings you closer to the divine",
                    "🌟 Your heart is opening to infinite love",
                    "💫 Sacred energy fills every cell of your being",
                    "🌺 Divine peace descends upon you",
                    "🎭 Maharaj-ji smiles at your dedication",
                    "🌙 Sacred vibrations heal and bless you",
                    "🏔️ Kainchi Dham's blessings flow to you",
                    "🌈 Divine light illuminates your path",
                    "🦋 Your soul dances with joy in devotion",
                    "🌊 Ocean of love washes over you",
                    "⭐ You are held in infinite grace"
                ];
                
                this.initializeElements();
                this.attachEventListeners();
                this.preloadFirstImage();
                
                // Track page view
                trackGA4Event('page_view', {
                    page_title: 'Naam Jap Counter',
                    page_location: window.location.href
                });
            }

            initializeElements() {
                this.audio = document.getElementById('ramRamAudio');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.currentImage = document.getElementById('currentImage');
                this.imageLoading = document.getElementById('imageLoading');
                this.blessingText = document.getElementById('blessingText');
                this.audioStatus = document.getElementById('audioStatus');
                
                // Counter elements
                this.currentCountEl = document.getElementById('currentCount');
                this.targetCountEl = document.getElementById('targetCount');
                this.remainingCountEl = document.getElementById('remainingCount');
                this.sessionTimeEl = document.getElementById('sessionTime');
                this.progressFill = document.getElementById('progressFill');
                
                // Set initial volume
                this.audio.volume = this.volumeSlider.value;
            }

            attachEventListeners() {
                // Session selection
                document.querySelectorAll('.session-option').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectSession(e));
                });

                document.getElementById('startPractice').addEventListener('click', () => this.startPracticeSession());

                // Practice controls
                document.getElementById('playPauseBtn').addEventListener('click', () => this.togglePractice());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetSession());
                document.getElementById('completeBtn').addEventListener('click', () => this.completeSession());
                document.getElementById('backToSelection').addEventListener('click', () => this.backToSelection());

                // Volume control
                this.volumeSlider.addEventListener('input', () => {
                    this.audio.volume = this.volumeSlider.value;
                });

                // Session complete controls
                document.getElementById('anotherSession').addEventListener('click', () => this.backToSelection());
                document.getElementById('shareProgress').addEventListener('click', () => this.shareProgress());

                // Audio events
                this.audio.addEventListener('loadeddata', () => this.audioLoaded());
                this.audio.addEventListener('error', () => this.audioError());
                this.audio.addEventListener('canplaythrough', () => {
                    console.log('Audio ready to play');
                });
            }

            selectSession(e) {
                // Remove previous selection
                document.querySelectorAll('.session-option').forEach(btn => {
                    btn.classList.remove('selected');
                });

                // Select current
                const selectedBtn = e.target.closest('.session-option');
                selectedBtn.classList.add('selected');
                
                this.selectedSession = {
                    count: parseInt(selectedBtn.dataset.count),
                    duration: parseFloat(selectedBtn.dataset.duration)
                };

                // Track session selection
                trackGA4Event('session_selected', {
                    session_count: this.selectedSession.count,
                    estimated_duration: this.selectedSession.duration
                });

                // Enable start button
                const startBtn = document.getElementById('startPractice');
                startBtn.style.opacity = '1';
                startBtn.style.pointerEvents = 'auto';
                startBtn.textContent = `🙏 Start ${this.selectedSession.count} Ram Ram Practice`;
            }

            startPracticeSession() {
                if (!this.selectedSession) return;

                // Track practice start
                trackGA4Event('practice_started', {
                    session_count: this.selectedSession.count,
                    estimated_duration: this.selectedSession.duration
                });

                // Reset session state
                this.targetCount = this.selectedSession.count;
                this.currentCount = 0;
                this.startTime = null;
                this.pausedTime = 0;
                this.isPlaying = false;

                // Reset audio
                this.audio.pause();
                this.audio.currentTime = 0;

                // Show practice session
                document.getElementById('sessionSelection').style.display = 'none';
                document.getElementById('practiceSession').classList.add('active');

                // Update display
                this.targetCountEl.textContent = this.targetCount;
                this.updateCounterDisplay();
                this.updateProgress();

                // Update audio status
                const loops = Math.ceil(this.selectedSession.duration / this.AUDIO_DURATION_MINUTES);
                this.audioStatus.textContent = `🎵 Ready - will loop ${loops} time${loops > 1 ? 's' : ''} for ${this.selectedSession.duration} minutes`;

                // Load first random image
                this.loadRandomImage();

                // Reset button
                document.getElementById('playPauseBtn').innerHTML = '▶ Start Practice';
            }

            togglePractice() {
                if (!this.isPlaying) {
                    // Start practice
                    this.startTime = Date.now() - this.pausedTime;
                    this.isPlaying = true;
                    
                    // Track practice play
                    trackGA4Event('practice_play', {
                        session_count: this.targetCount,
                        current_count: this.currentCount
                    });
                    
                    // Try to start audio with better error handling
                    const audioPromise = this.audio.play();
                    
                    if (audioPromise !== undefined) {
                        audioPromise.then(() => {
                            console.log('Audio started successfully');
                            this.audioStatus.textContent = '🎵 Audio playing - chant along with Maharaj-ji';
                            this.audioStatus.style.background = 'rgba(255, 255, 255, 0.2)';
                            this.audioStatus.style.color = 'white';
                        }).catch(e => {
                            console.warn('Audio play failed:', e);
                            this.audioStatus.textContent = '🔇 Audio blocked - try clicking START again or adjust volume';
                            this.audioStatus.style.background = 'rgba(255, 255, 255, 0.9)';
                            this.audioStatus.style.color = '#7A0019';
                        });
                    }
                    
                    document.getElementById('playPauseBtn').innerHTML = '⏸️ Pause';
                    
                    // Start counting and image rotation
                    this.startCounting();
                    this.scheduleImageChange();
                    this.scheduleSessionComplete();
                    
                } else {
                    // Pause practice
                    this.pausedTime = Date.now() - this.startTime;
                    this.isPlaying = false;
                    
                    // Track practice pause
                    trackGA4Event('practice_pause', {
                        session_count: this.targetCount,
                        current_count: this.currentCount,
                        progress_percentage: (this.currentCount / this.targetCount) * 100
                    });
                    
                    this.audio.pause();
                    document.getElementById('playPauseBtn').innerHTML = '▶ Resume';
                    
                    this.audioStatus.textContent = '⏸️ Practice paused - click Resume to continue';
                    this.audioStatus.style.background = 'rgba(255, 255, 255, 0.2)';
                    this.audioStatus.style.color = 'white';
                    
                    // Stop intervals
                    this.stopCounting();
                    this.clearTimeouts();
                }
            }

            startCounting() {
                this.countingInterval = setInterval(() => {
                    if (this.isPlaying && this.startTime) {
                        const elapsedMs = Date.now() - this.startTime;
                        const elapsedMinutes = elapsedMs / (1000 * 60);
                        this.currentCount = Math.floor(elapsedMinutes * this.RAM_RAM_PACE);
                        
                        // Cap at target
                        if (this.currentCount >= this.targetCount) {
                            this.currentCount = this.targetCount;
                            this.autoCompleteSession();
                            return;
                        }
                        
                        this.updateCounterDisplay();
                        this.updateProgress();
                    }
                }, 1000);
            }

            stopCounting() {
                if (this.countingInterval) {
                    clearInterval(this.countingInterval);
                    this.countingInterval = null;
                }
            }

            scheduleImageChange() {
                const changeImage = () => {
                    if (this.isPlaying) {
                        this.loadRandomImage();
                        this.changeBlessingText();
                        
                        // Schedule next change
                        const nextInterval = 8000 + Math.random() * 4000; // 8-12 seconds
                        this.imageChangeTimeout = setTimeout(changeImage, nextInterval);
                    }
                };
                
                // First change after 8 seconds
                this.imageChangeTimeout = setTimeout(changeImage, 8000);
            }

            scheduleSessionComplete() {
                // Auto-complete when target reached
                const targetMs = (this.targetCount / this.RAM_RAM_PACE) * 60 * 1000;
                this.sessionCompleteTimeout = setTimeout(() => {
                    if (this.isPlaying) {
                        this.autoCompleteSession();
                    }
                }, targetMs);
            }

            clearTimeouts() {
                if (this.imageChangeTimeout) {
                    clearTimeout(this.imageChangeTimeout);
                    this.imageChangeTimeout = null;
                }
                if (this.sessionCompleteTimeout) {
                    clearTimeout(this.sessionCompleteTimeout);
                    this.sessionCompleteTimeout = null;
                }
            }

            loadRandomImage() {
                if (this.isLoadingImage) return;
                this.isLoadingImage = true;

                // Get random image that hasn't been used
                let randomIndex;
                let attempts = 0;
                do {
                    randomIndex = Math.floor(Math.random() * this.TOTAL_IMAGES) + 1;
                    attempts++;
                } while (this.usedImages.has(randomIndex) && this.usedImages.size < this.TOTAL_IMAGES && attempts < 10);

                // If we've used all images, reset the used set
                if (this.usedImages.size >= this.TOTAL_IMAGES) {
                    this.usedImages.clear();
                }

                this.usedImages.add(randomIndex);
                this.loadImage(randomIndex);
            }

            loadImage(imageIndex) {
                const img = new Image();
                const imagePath = `images/darshan/nkb-${imageIndex}.jpg`;
                
                img.onload = () => {
                    // Fade out current image
                    this.currentImage.classList.remove('active');
                    this.imageLoading.classList.remove('show');
                    
                    setTimeout(() => {
                        this.currentImage.src = imagePath;
                        this.currentImage.style.display = 'block';
                        this.currentImage.classList.add('active');
                        this.currentImageIndex = imageIndex;
                        this.isLoadingImage = false;
                    }, 500);
                };

                img.onerror = () => {
                    console.warn(`Failed to load image: ${imagePath}`);
                    this.usedImages.delete(imageIndex);
                    this.isLoadingImage = false;
                    
                    // Try loading another image
                    if (this.isPlaying) {
                        setTimeout(() => this.loadRandomImage(), 1000);
                    }
                };

                img.src = imagePath;
            }

            preloadFirstImage() {
                // Load first image on page load
                this.loadImage(1);
            }

            changeBlessingText() {
                const randomBlessing = this.blessings[Math.floor(Math.random() * this.blessings.length)];
                this.blessingText.classList.add('fade-transition');
                this.blessingText.style.opacity = '0';
                
                setTimeout(() => {
                    this.blessingText.textContent = randomBlessing;
                    this.blessingText.style.opacity = '1';
                }, 300);
            }

            updateCounterDisplay() {
                this.currentCountEl.textContent = this.currentCount;
                this.remainingCountEl.textContent = Math.max(0, this.targetCount - this.currentCount);
                
                // Update session time
                if (this.startTime) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    this.sessionTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            updateProgress() {
                const progress = Math.min((this.currentCount / this.targetCount) * 100, 100);
                this.progressFill.style.width = `${progress}%`;
            }

            autoCompleteSession() {
                // Ensure we hit the target count
                this.currentCount = this.targetCount;
                this.updateCounterDisplay();
                this.updateProgress();
                
                // Complete after a brief delay
                setTimeout(() => {
                    this.completeSession();
                }, 1000);
            }

            completeSession() {
                // Stop everything
                this.isPlaying = false;
                this.audio.pause();
                this.stopCounting();
                this.clearTimeouts();

                // Calculate actual duration
                const actualDuration = this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0;

                // Track session completion
                trackGA4Event('practice_completed', {
                    session_count: this.targetCount,
                    completed_count: this.currentCount,
                    actual_duration: actualDuration,
                    completion_rate: (this.currentCount / this.targetCount) * 100,
                    event_value: this.currentCount >= this.targetCount ? 1 : 0
                });

                // Save session data
                this.saveSession();

                // Show completion screen
                document.getElementById('practiceSession').classList.remove('active');
                document.getElementById('sessionComplete').classList.add('show');

                // Update completion stats
                this.updateCompletionStats();

                // Add celebration effect
                document.getElementById('sessionComplete').classList.add('celebrating');
                setTimeout(() => {
                    document.getElementById('sessionComplete').classList.remove('celebrating');
                }, 1500);
            }

            saveSession() {
                const actualDuration = this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0;
                const sessionRecord = {
                    date: new Date().toDateString(),
                    count: this.currentCount,
                    target: this.targetCount,
                    duration: actualDuration,
                    completed: this.currentCount >= this.targetCount
                };

                this.sessionData.sessions.push(sessionRecord);
                this.sessionData.totalCount += this.currentCount;
                
                // Update today's count and streak
                const today = new Date().toDateString();
                if (this.sessionData.lastDate !== today) {
                    // New day - update streak
                    if (this.sessionData.lastDate) {
                        const lastDate = new Date(this.sessionData.lastDate);
                        const currentDate = new Date(today);
                        const dayDiff = Math.ceil((currentDate.getTime() - lastDate.getTime()) / (1000 * 3600 * 24));
                        
                        if (dayDiff === 1) {
                            this.sessionData.streak = (this.sessionData.streak || 0) + 1;
                        } else if (dayDiff > 1) {
                            this.sessionData.streak = 1;
                        }
                    } else {
                        this.sessionData.streak = 1;
                    }
                    
                    this.sessionData.lastDate = today;
                    this.sessionData.todayCount = this.currentCount;
                } else {
                    // Same day - add to today's count
                    this.sessionData.todayCount += this.currentCount;
                }

                this.saveSessionData();
            }

            updateCompletionStats() {
                document.getElementById('completedCount').textContent = this.currentCount;
                
                const duration = this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('actualDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('todayTotal').textContent = this.sessionData.todayCount.toLocaleString();
                document.getElementById('overallTotal').textContent = this.sessionData.totalCount.toLocaleString();
            }

            resetSession() {
                if (confirm('Are you sure you want to reset this session? All progress will be lost.')) {
                    // Track reset
                    trackGA4Event('practice_reset', {
                        session_count: this.targetCount,
                        lost_count: this.currentCount,
                        progress_percentage: (this.currentCount / this.targetCount) * 100
                    });

                    // Stop everything
                    this.isPlaying = false;
                    this.audio.pause();
                    this.audio.currentTime = 0;
                    this.stopCounting();
                    this.clearTimeouts();

                    // Reset counters
                    this.currentCount = 0;
                    this.startTime = null;
                    this.pausedTime = 0;

                    // Reset UI
                    document.getElementById('playPauseBtn').innerHTML = '▶ Start Practice';
                    this.updateCounterDisplay();
                    this.updateProgress();

                    // Reset audio status
                    this.audioStatus.textContent = '🎵 Ready to start - audio will loop automatically for your session';
                    this.audioStatus.style.background = 'rgba(255, 255, 255, 0.2)';
                    this.audioStatus.style.color = 'white';

                    // Reset images
                    this.usedImages.clear();
                    this.loadRandomImage();
                }
            }

            backToSelection() {
                // Track back to selection
                trackGA4Event('back_to_selection', {
                    current_count: this.currentCount,
                    target_count: this.targetCount,
                    was_playing: this.isPlaying
                });

                // Stop everything
                this.isPlaying = false;
                this.audio.pause();
                this.audio.currentTime = 0;
                this.stopCounting();
                this.clearTimeouts();

                // Reset session state
                this.currentCount = 0;
                this.startTime = null;
                this.pausedTime = 0;
                this.selectedSession = null;

                // Reset UI
                document.getElementById('playPauseBtn').innerHTML = '▶ Start Practice';
                this.updateCounterDisplay();
                this.updateProgress();

                // Show selection, hide others
                document.getElementById('sessionSelection').style.display = 'block';
                document.getElementById('practiceSession').classList.remove('active');
                document.getElementById('sessionComplete').classList.remove('show');

                // Clear selection
                document.querySelectorAll('.session-option').forEach(btn => {
                    btn.classList.remove('selected');
                });

                const startBtn = document.getElementById('startPractice');
                startBtn.style.opacity = '0.5';
                startBtn.style.pointerEvents = 'none';
                startBtn.textContent = '🙏 Start Guided Practice';

                // Reset images
                this.usedImages.clear();
            }

            shareProgress() {
                // Track share
                trackGA4Event('progress_shared', {
                    completed_count: this.currentCount,
                    today_total: this.sessionData.todayCount,
                    lifetime_total: this.sessionData.totalCount,
                    streak: this.sessionData.streak
                });

                const message = `🙏 Just completed ${this.currentCount} Ram Ram with Maharaj-ji's divine guidance!\n\n📿 Today's total: ${this.sessionData.todayCount.toLocaleString()}\n🌟 Lifetime total: ${this.sessionData.totalCount.toLocaleString()}\n🔥 Streak: ${this.sessionData.streak} days\n\nJoin me in guided Ram Ram practice: ${window.location.href}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Naam Jap Practice Complete',
                        text: message
                    });
                } else {
                    navigator.clipboard.writeText(message).then(() => {
                        alert('🙏 Progress copied to clipboard! Share your spiritual practice with others.');
                    }).catch(() => {
                        alert(`Share your spiritual journey:\n\n${message}`);
                    });
                }
            }

            audioLoaded() {
                console.log('Audio loaded successfully');
                this.audioStatus.textContent = '🎵 Audio ready - choose your session and start practice';
            }

            audioError() {
                console.warn('Audio failed to load');
                this.audioStatus.textContent = '⚠️ Audio unavailable - practice in silence with visual guidance';
                this.audioStatus.style.background = 'rgba(255, 255, 255, 0.9)';
                this.audioStatus.style.color = '#7A0019';
            }

            loadSessionData() {
                const defaultData = {
                    totalCount: 0,
                    todayCount: 0,
                    streak: 0,
                    lastDate: null,
                    sessions: []
                };

                try {
                    const stored = localStorage.getItem('naamJapData');
                    const data = stored ? { ...defaultData, ...JSON.parse(stored) } : defaultData;
                    
                    // Reset today's count if new day
                    const today = new Date().toDateString();
                    if (data.lastDate !== today) {
                        data.todayCount = 0;
                    }
                    
                    return data;
                } catch (e) {
                    return defaultData;
                }
            }

            saveSessionData() {
                try {
                    localStorage.setItem('naamJapData', JSON.stringify(this.sessionData));
                } catch (e) {
                    console.warn('Could not save session data');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new NaamJapCounter();
        });

        // Track back button click
        document.querySelector('.nav-btn').addEventListener('click', function() {
            trackGA4Event('navigation_click', {
                destination: 'homepage',
                source_page: 'naam_jap_counter'
            });
        });
    </script>
</body>
</html>
