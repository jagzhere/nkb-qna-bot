<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NKB QnA Bot - Devotees' Stories</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fef9e7 0%, #fdf2e9 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 2.2rem;
            color: #7A0019;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            font-style: italic;
        }

        /* Language Toggle */
        .language-toggle {
            text-align: center;
            margin-bottom: 20px;
        }

        .language-toggle label {
            font-weight: 600;
            margin-right: 15px;
            color: #7A0019;
        }

        .language-buttons {
            display: inline-flex;
            border: 2px solid #FF6A00;
            border-radius: 25px;
            overflow: hidden;
            background: white;
        }

        .language-btn {
            padding: 8px 20px;
            border: none;
            background: white;
            color: #FF6A00;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .language-btn.active {
            background: #FF6A00;
            color: white;
        }

        .language-btn:hover:not(.active) {
            background: #fff5f0;
        }

        /* Navigation Cards */
        .nav-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-card {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
            color: inherit;
        }

        .nav-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #FF6A00;
        }

        .daily-darshan {
            background: linear-gradient(135deg, #7A0019, #a4002a);
            color: white;
        }

        .guided-meditation {
            background: linear-gradient(135deg, #FF6A00, #ff8533);
            color: white;
        }

        .naam-jap-counter {
            background: linear-gradient(135deg, #7A0019, #a4002a);
            color: white;
        }

        .nav-card h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .nav-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Main Content Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }

        /* Ask Section */
        .ask-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .ask-section h2 {
            color: #7A0019;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* Topic Selection - Now at top */
        .topic-section {
            margin-bottom: 25px;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .topic-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .topic-option:hover {
            background-color: #fff5f0;
        }

        .topic-option input[type="radio"] {
            accent-color: #FF6A00;
        }

        .topic-option label {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .question-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .question-input:focus {
            outline: none;
            border-color: #FF6A00;
        }

        .word-count {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        /* Ask Button */
        .ask-button {
            width: 100%;
            padding: 15px;
            background: #FF6A00;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .ask-button:hover {
            background: #e55a00;
        }

        .ask-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Results Section */
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .results-section h2 {
            color: #7A0019;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .welcome-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .welcome-message .emoji {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #FF6A00;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF6A00;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Response Sections */
        .response-section {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 10px;
        }

        .empathy-section {
            background: #f0f9ff;
            border-left: 4px solid #FF6A00;
            font-style: italic;
            color: #555;
        }

        .stories-section h3 {
            color: #7A0019;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .story-card {
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s ease;
        }

        .story-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .story-card h4 {
            color: #7A0019;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .story-relevance {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 3px solid #FF6A00;
        }

        .story-preview {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .story-full {
            display: none;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .story-source {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .read-more-btn {
            background: #7A0019;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .read-more-btn:hover {
            background: #5a0013;
        }

        .lessons-section {
            background: #fff8f0;
            border-left: 4px solid #FF6A00;
        }

        .lessons-section h4 {
            color: #FF6A00;
            margin-bottom: 15px;
        }

        .lessons-section ul {
            margin-left: 20px;
        }

        .lessons-section li {
            margin-bottom: 10px;
            color: #555;
            line-height: 1.6;
        }

        .reflection-section {
            background: #fff9f0;
            border-left: 4px solid #7A0019;
        }

        .community-section {
            background: #f8f9ff;
            border-left: 4px solid #4CAF50;
            color: #4CAF50;
            font-weight: 500;
        }

        .practice-section {
            background: #fff5f0;
            border-left: 4px solid #FF6A00;
        }

        .practice-section h4 {
            color: #FF6A00;
            margin-bottom: 10px;
        }

        .nextsteps-section {
            background: #f0f9ff;
            border-left: 4px solid #2196F3;
        }

        .nextsteps-section h4 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .gratitude-section {
            background: #f8f5ff;
            border-left: 4px solid #9C27B0;
            text-align: center;
            font-style: italic;
        }

        .feedback-section {
            text-align: center;
            margin-top: 25px;
        }

        .feedback-buttons {
            margin-top: 10px;
        }

        .feedback-btn {
            margin: 0 5px;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .feedback-yes {
            background: #4CAF50;
            color: white;
        }

        .feedback-no {
            background: #f44336;
            color: white;
        }

        .load-more-btn {
            width: 100%;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: #e8e8e8;
        }

        /* Error/Fallback */
        .fallback-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .fallback-message .emoji {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .try-again-btn {
            background: #FF6A00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .nav-cards {
                flex-direction: column;
                align-items: center;
            }

            .nav-card {
                width: 100%;
                max-width: 300px;
                text-align: center;
            }

            .topic-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            .ask-section,
            .results-section {
                padding: 20px;
            }

            .response-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
<!-- Navigation Cards -->
        <div class="nav-cards">
            <a href="/daily-darshan.html" class="nav-card daily-darshan">
                <h3 id="navDarshan">Daily Darshan</h3>
                <p id="navDarshanDesc">Connect with Maharaj-ji daily</p>
            </a>
            <a href="/guided-meditation.html" class="nav-card guided-meditation">
                <h3 id="navMeditation">Guided Meditation</h3>
                <p id="navMeditationDesc">Ram Ram meditation practice</p>
            </a>
            <a href="/naam-jap-counter.html" class="nav-card naam-jap-counter">
                <h3 id="navCounter">Naam Jap Counter</h3>
                <p id="navCounterDesc">Chant with Maharajji</p>
            </a>
        </div>
        
        <!-- Header -->
        <div class="header">
            <h1>Devotees' Stories and Experiences</h1>
            <p>You AREN'T Alone</p>
        </div>

        <!-- Language Toggle -->
        <div class="language-toggle">
            <label>Choose your language:</label>
            <div class="language-buttons">
                <button class="language-btn active" id="englishBtn" onclick="setLanguage('english')">English</button>
                <button class="language-btn" id="hindiBtn" onclick="setLanguage('hindi')">हिंदी</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Ask Section -->
            <div class="ask-section">
                <h2 id="askSectionTitle">What's in your heart</h2>
                
                <div class="topic-section">
                    <label id="topicLabel"><strong>Topic (helps us find relevant stories)</strong></label>
                    <div class="topic-grid">
                        <div class="topic-option">
                            <input type="radio" name="topic" value="work" id="work">
                            <label for="work" id="topicWork">Work/Finances</label>
                        </div>
                        <div class="topic-option">
                            <input type="radio" name="topic" value="relationships" id="relationships">
                            <label for="relationships" id="topicRelationships">Relationships/Family</label>
                        </div>
                        <div class="topic-option">
                            <input type="radio" name="topic" value="health" id="health">
                            <label for="health" id="topicHealth">Health/Body</label>
                        </div>
                        <div class="topic-option">
                            <input type="radio" name="topic" value="grief" id="grief">
                            <label for="grief" id="topicGrief">Grief/Loss</label>
                        </div>
                        <div class="topic-option">
                            <input type="radio" name="topic" value="faith" id="faith">
                            <label for="faith" id="topicFaith">Faith/Practice</label>
                        </div>
                        <div class="topic-option">
                            <input type="radio" name="topic" value="other" id="other">
                            <label for="other" id="topicOther">Other</label>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <textarea 
                        class="question-input" 
                        placeholder="Share what's troubling you..."
                        maxlength="150"
                        id="questionInput"
                    ></textarea>
                    <div class="word-count" id="wordCount">0/25 words (auto-truncated)</div>
                </div>

                <button class="ask-button" id="askButton">Ask</button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2 id="resultsSectionTitle">Stories for You</h2>
                
                <div class="welcome-message" id="welcomeMessage">
                    <span class="emoji">🙏</span>
                    <p id="welcomeText">Ask your question and discover stories from fellow devotees who've walked similar paths.</p>
                </div>

                <div class="loading" id="loadingState" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loadingText">Maharajji is listening...</p>
                </div>

                <div id="resultsContent" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
                
                <div class="fallback-message" id="fallbackMessage" style="display: none;">
                    <span class="emoji">🙏</span>
                    <p id="fallbackText"></p>
                    <button class="try-again-btn" onclick="resetForm()" id="tryAgainBtn">Ask differently</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFingerprint = null;
        let loadedStoryCount = 0;
        let currentLanguage = 'english';

        // Analytics Integration - ENHANCED
        let currentSessionId = null;
        let sessionStartTime = new Date();

        // Generate session ID
        function generateSessionId() {
            return `${currentFingerprint}-${Date.now()}`;
        }

        // FIXED: Track analytics with proper error handling
        async function trackAnalytics(action, data = {}) {
            try {
                console.log(`Tracking analytics: ${action}`, data);
                const response = await fetch('/api/analytics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action,
                        fingerprint: currentFingerprint,
                        sessionId: currentSessionId,
                        timestamp: new Date().toISOString(),
                        ...data
                    })
                });
                
                if (response.ok) {
                    console.log(`Analytics ${action} tracked successfully`);
                } else {
                    console.error(`Analytics ${action} failed:`, response.status);
                }
            } catch (error) {
                console.log(`Analytics ${action} failed:`, error);
            }
        }

        // Track page view
        async function trackPageView(page = window.location.pathname, referrer = document.referrer) {
            await trackAnalytics('page_view', {
                page,
                referrer,
                userAgent: navigator.userAgent,
                language: currentLanguage
            });
        }

        // Track feature usage with specific actions
        async function trackFeatureUsage(feature, action = 'use') {
            await trackAnalytics('feature_usage', {
                feature,
                action,
                language: currentLanguage
            });
        }

        // Translation object
        const translations = {
            english: {
                navDarshan: "Daily Darshan",
                navDarshanDesc: "Connect with Maharaj-ji daily",
                navMeditation: "Guided Meditation",
                navMeditationDesc: "Ram Ram meditation practice",
                navCounter: "Naam Jap Counter",
                navCounterDesc: "Chant with Maharajji",
                askSectionTitle: "What's in your heart",
                topicLabel: "Topic (helps us find relevant stories)",
                topicWork: "Work/Finances",
                topicRelationships: "Relationships/Family",
                topicHealth: "Health/Body",
                topicGrief: "Grief/Loss",
                topicFaith: "Faith/Practice",
                topicOther: "Other",
                resultsSectionTitle: "Stories for You",
                welcomeText: "Ask your question and discover stories from fellow devotees who've walked similar paths.",
                loadingText: "Maharajji is listening...",
                askButton: "Ask",
                tryAgainBtn: "Ask differently",
                placeholders: {
                    work: "e.g., 'Lost my job and feel hopeless' or 'Struggling financially'",
                    relationships: "e.g., 'My daughter won't talk to me' or 'Marriage feels distant'",
                    health: "e.g., 'Dealing with chronic illness' or 'Body feels weak'",
                    grief: "e.g., 'Lost my mother recently' or 'Grieving a relationship'",
                    faith: "e.g., 'Questioning my beliefs' or 'Can't feel God's presence'",
                    other: "e.g., 'Feeling lost in life' or 'Need spiritual guidance'"
                }
            },
            hindi: {
                navDarshan: "दैनिक दर्शन",
                navDarshanDesc: "महाराज जी से रोज़ाना जुड़ें",
                navMeditation: "निर्देशित ध्यान",
                navMeditationDesc: "राम राम ध्यान अभ्यास",
                askSectionTitle: "आपके दिल में क्या है",
                topicLabel: "विषय (प्रासंगिक कहानियां खोजने में मदद करता है)",
                topicWork: "काम/वित्त",
                topicRelationships: "रिश्ते/परिवार",
                topicHealth: "स्वास्थ्य/शरीर",
                topicGrief: "दुख/हानि",
                topicFaith: "श्रद्धा/अभ्यास",
                topicOther: "अन्य",
                resultsSectionTitle: "आपके लिए कहानियां",
                welcomeText: "अपना प्रश्न पूछें और उन साथी भक्तों की कहानियां खोजें जिन्होंने समान रास्ते तय किए हैं।",
                loadingText: "महाराज जी सुन रहे हैं...",
                askButton: "पूछें",
                tryAgainBtn: "अलग तरीके से पूछें",
                placeholders: {
                    work: "उदा., 'नौकरी खो गई और निराश हूं' या 'आर्थिक परेशानी'",
                    relationships: "उदा., 'मेरी बेटी मुझसे बात नहीं करती' या 'शादी में दूरी'",
                    health: "उदा., 'पुरानी बीमारी से जूझ रहा हूं' या 'शरीर कमजोर लगता है'",
                    grief: "उदा., 'मां को हाल ही में खोया' या 'रिश्ते का दुख'",
                    faith: "उदा., 'अपनी मान्यताओं पर सवाल' या 'भगवान की उपस्थिति महसूस नहीं'",
                    other: "उदा., 'जीवन में खोया महसूस' या 'आध्यात्मिक मार्गदर्शन चाहिए'"
                }
            }
        };

        // Generate browser fingerprint
        function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            
            const fingerprint = canvas.toDataURL() + 
                navigator.userAgent + 
                screen.width + 'x' + screen.height + 
                new Date().getTimezoneOffset() + 
                navigator.language;
                
            return btoa(fingerprint).substring(0, 32);
        }

        // Set language function
        function setLanguage(language) {
            currentLanguage = language;
            
            // Track language toggle
            trackFeatureUsage('language-toggle', language);
            
            // Update button states
            document.getElementById('englishBtn').classList.toggle('active', language === 'english');
            document.getElementById('hindiBtn').classList.toggle('active', language === 'hindi');
            
            // Update UI text
            const t = translations[language];
            Object.keys(t).forEach(key => {
                if (key !== 'placeholders') {
                    const element = document.getElementById(key);
                    if (element) {
                        element.textContent = t[key];
                    }
                }
            });
            
            // Update placeholder based on selected topic
            updatePlaceholder();
        }

        // Update placeholder based on topic selection
        function updatePlaceholder() {
            const selectedTopic = document.querySelector('input[name="topic"]:checked');
            const questionInput = document.getElementById('questionInput');
            
            if (selectedTopic) {
                const topicValue = selectedTopic.value;
                const placeholder = translations[currentLanguage].placeholders[topicValue];
                questionInput.placeholder = placeholder;
            } else {
                const defaultPlaceholder = currentLanguage === 'hindi' ? 
                    'जो आपको परेशान कर रहा है उसे साझा करें...' : 
                    'Share what\'s troubling you...';
                questionInput.placeholder = defaultPlaceholder;
            }
        }

        // Initialize analytics and fingerprint on page load
        document.addEventListener('DOMContentLoaded', async function() {
            currentFingerprint = generateFingerprint();
            currentSessionId = generateSessionId();
            
            console.log('Initializing analytics with fingerprint:', currentFingerprint);
            
            // Track initial page view
            await trackPageView();
            
            // Add topic selection listeners
            document.querySelectorAll('input[name="topic"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePlaceholder();
                    trackFeatureUsage('topic-selection', this.value);
                });
            });

            // Track navigation card clicks
            document.querySelectorAll('.nav-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    const feature = this.href.includes('daily-darshan') ? 'daily-darshan' : 'guided-meditation';
                    trackFeatureUsage('navigation', feature);
                });
            });
        });

        // Word count functionality
        const questionInput = document.getElementById('questionInput');
        const wordCount = document.getElementById('wordCount');
        const askButton = document.getElementById('askButton');

        questionInput.addEventListener('input', function() {
            const text = this.value.trim();
            const words = text === '' ? [] : text.split(/\s+/);
            const wordLength = words.length;
            
            const countText = currentLanguage === 'hindi' ? 
                'शब्द (स्वतः-छंटे गए)' : 'words (auto-truncated)';
            
            if (wordLength > 25) {
                const truncated = words.slice(0, 25).join(' ');
                this.value = truncated;
                wordCount.textContent = `25/25 ${countText}`;
                wordCount.style.color = '#FF6A00';
            } else {
                wordCount.textContent = `${wordLength}/25 ${countText}`;
                wordCount.style.color = '#888';
            }
        });

        // Ask button functionality
        askButton.addEventListener('click', async function() {
            const question = questionInput.value.trim();
            const selectedTopic = document.querySelector('input[name="topic"]:checked');
            
            const noQuestionAlert = currentLanguage === 'hindi' ? 
                'कृपया पहले अपने दिल की बात साझा करें' : 
                'Please share what\'s in your heart first';
            const noTopicAlert = currentLanguage === 'hindi' ? 
                'कृपया प्रासंगिक कहानियां खोजने के लिए एक विषय चुनें' : 
                'Please select a topic to help us find relevant stories';
            
            if (!question) {
                alert(noQuestionAlert);
                return;
            }
            
            if (!selectedTopic) {
                alert(noTopicAlert);
                return;
            }

            // Show loading state
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('fallbackMessage').style.display = 'none';

            try {
                const response = await fetch('/api/search-stories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        topic: selectedTopic.value,
                        fingerprint: currentFingerprint,
                        language: currentLanguage
                    })
                });

                const data = await response.json();

                // Permanent debugging - log API response and similarity scores
                console.log('=== API RESPONSE DEBUG ===');
                console.log('Full API Response:', data);
                if (data.stories && data.stories.length > 0) {
                    console.log('Story Similarity Scores:');
                    data.stories.forEach((story, i) => {
                        console.log(`${i+1}. "${story.title}" - Similarity: ${story.similarity ? story.similarity.toFixed(3) : 'N/A'}`);
                    });
                } else {
                    console.log('No stories returned');
                }
                console.log('========================');

                document.getElementById('loadingState').style.display = 'none';

                if (response.status === 429) {
                    // Rate limit exceeded
                    const limitMessage = currentLanguage === 'hindi' ? 
                        'आपने 3 प्रश्नों की दैनिक सीमा पूरी कर ली है। कृपया कल फिर कोशिश करें।' :
                        'You\'ve reached your daily limit of 3 questions. Please try again tomorrow.';
                    document.getElementById('fallbackMessage').style.display = 'block';
                    document.getElementById('fallbackText').textContent = limitMessage;
                    return;
                }

                if (data.fallback) {
                    // No matching stories found
                    document.getElementById('fallbackMessage').style.display = 'block';
                    document.getElementById('fallbackText').textContent = data.message;
                    return;
                }

                // Display results
                displayResults(data);
                loadedStoryCount = data.stories.length;

                // Scroll to results on mobile
                if (window.innerWidth <= 768) {
                    document.querySelector('.results-section').scrollIntoView({
                        behavior: 'smooth'
                    });
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('fallbackMessage').style.display = 'block';
                const errorMessage = currentLanguage === 'hindi' ? 
                    'कुछ गलत हुआ। कृपया फिर कोशिश करें।' :
                    'Something went wrong. Please try again.';
                document.getElementById('fallbackText').textContent = errorMessage;
            }
        });

        // Display results function
        function displayResults(data) {
            const resultsContent = document.getElementById('resultsContent');
            
            let html = '';

            // 1. Empathy line
            if (data.empathy) {
                html += `
                    <div class="response-section empathy-section">
                        <p><em>${data.empathy}</em></p>
                    </div>
                `;
            }

            // 2. What the sources say
            if (data.stories && data.stories.length > 0) {
                const sourcesTitle = currentLanguage === 'hindi' ? 'स्रोत क्या कहते हैं' : 'What the sources say';
                html += `
                    <div class="response-section stories-section">
                        <h3>${sourcesTitle}</h3>
                `;

                data.stories.forEach((story, index) => {
                    const storyId = `story-${index}`;
                    const cleanContent = story.content.replace(/\\n\\n/g, ' ').replace(/\\n/g, ' ');
                    const preview = cleanContent.substring(0, 150) + (cleanContent.length > 150 ? '...' : '');
                    const readMoreText = currentLanguage === 'hindi' ? 'और पढ़ें' : 'Read more';
                    const showLessText = currentLanguage === 'hindi' ? 'कम दिखाएं' : 'Show less';
                    const sourceText = currentLanguage === 'hindi' ? 'स्रोत:' : 'Source:';
                    
                    html += `
                        <div class="story-card">
                            <h4>${story.title}</h4>
                            ${story.relevance ? `<div class="story-relevance">${story.relevance}</div>` : ''}
                            <div class="story-preview" id="preview-${storyId}">
                                ${preview}
                            </div>
                            <div class="story-full" id="full-${storyId}">
                                ${story.content.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>')}
                                <div class="story-source">
                                    <strong>${sourceText}</strong> ${story.source_url}
                                </div>
                            </div>
                            <button class="read-more-btn" onclick="toggleStory('${storyId}')" id="btn-${storyId}">
                                ${readMoreText}
                            </button>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // 3. Combined lessons section
            if (data.lessons && data.lessons.length > 0) {
                const lessonsTitle = currentLanguage === 'hindi' ? 
                    'ये कहानियां आपकी स्थिति के बारे में क्या सिखाती हैं' :
                    'What these stories teach about your situation';
                html += `
                    <div class="response-section lessons-section">
                        <h4>${lessonsTitle}</h4>
                        <ul>
                `;
                data.lessons.forEach(lesson => {
                    html += `<li>${lesson}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }

            // 4. Reflection question
            if (data.reflection) {
                const reflectionTitle = currentLanguage === 'hindi' ? 'चिंतन' : 'Reflection';
                html += `
                    <div class="response-section reflection-section">
                        <h4>${reflectionTitle}</h4>
                        <p>${data.reflection}</p>
                    </div>
                `;
            }

            // 5. Community element
            if (data.community) {
                html += `
                    <div class="response-section community-section">
                        <p>✨ ${data.community}</p>
                    </div>
                `;
            }

            // 6. Practice suggestion
            if (data.practice) {
                const practiceTitle = currentLanguage === 'hindi' ? 'अभ्यास' : 'Practice';
                html += `
                    <div class="response-section practice-section">
                        <h4>${practiceTitle}</h4>
                        <p>${data.practice}</p>
                    </div>
                `;
            }

            // 7. Gentle next steps
            if (data.nextSteps) {
                const nextStepsTitle = currentLanguage === 'hindi' ? 'जब आप तैयार हों' : 'When You\'re Ready';
                html += `
                    <div class="response-section nextsteps-section">
                        <h4>${nextStepsTitle}</h4>
                        <p>${data.nextSteps}</p>
                    </div>
                `;
            }

            // 8. Gratitude prompt
            if (data.gratitude) {
                html += `
                    <div class="response-section gratitude-section">
                        <p>${data.gratitude}</p>
                    </div>
                `;
            }

            // Feedback section
            const feedbackTitle = currentLanguage === 'hindi' ? 
                'क्या इस उत्तर से आपको मदद मिली?' :
                'Did this answer help you?';
            const yesText = currentLanguage === 'hindi' ? 'हां' : 'Yes';
            const noText = currentLanguage === 'hindi' ? 'नहीं' : 'No';
            
            html += `
                <div class="feedback-section">
                    <p><strong>${feedbackTitle}</strong></p>
                    <div class="feedback-buttons">
                        <button class="feedback-btn feedback-yes" onclick="submitFeedback('yes')">${yesText}</button>
                        <button class="feedback-btn feedback-no" onclick="submitFeedback('no')">${noText}</button>
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;
            document.getElementById('resultsContent').style.display = 'block';
        }

        // Toggle story expand/collapse
        function toggleStory(storyId) {
            const preview = document.getElementById(`preview-${storyId}`);
            const full = document.getElementById(`full-${storyId}`);
            const btn = document.getElementById(`btn-${storyId}`);
            const readMoreText = currentLanguage === 'hindi' ? 'और पढ़ें' : 'Read more';
            const showLessText = currentLanguage === 'hindi' ? 'कम दिखाएं' : 'Show less';

            if (full.style.display === 'none' || full.style.display === '') {
                preview.style.display = 'none';
                full.style.display = 'block';
                btn.textContent = showLessText;
                trackFeatureUsage('story-expansion', 'expand');
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
                btn.textContent = readMoreText;
                trackFeatureUsage('story-expansion', 'collapse');
            }
        }

        // Submit feedback with enhanced tracking
        async function submitFeedback(feedback) {
            console.log('Feedback:', feedback);
            
            // Track feedback
            await trackAnalytics('feedback', {
                helpful: feedback === 'yes',
                language: currentLanguage
            });
            
            // Show thank you message
            const buttons = document.querySelector('.feedback-buttons');
            const thankYouMessage = currentLanguage === 'hindi' ? 
                'आपके फीडबैक के लिए धन्यवाद!' :
                'Thank you for your feedback!';
            buttons.innerHTML = `<p style="color: #4CAF50; margin-top: 10px;">${thankYouMessage}</p>`;
        }

        // Reset form
        function resetForm() {
            document.getElementById('questionInput').value = '';
            const countText = currentLanguage === 'hindi' ? 
                'शब्द (स्वतः-छंटे गए)' : 'words (auto-truncated)';
            document.getElementById('wordCount').textContent = `0/25 ${countText}`;
            document.querySelectorAll('input[name="topic"]').forEach(radio => radio.checked = false);
            
            document.getElementById('welcomeMessage').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('fallbackMessage').style.display = 'none';
            
            loadedStoryCount = 0;
            updatePlaceholder(); // Reset placeholder
        }

        // Enhanced session tracking
        window.addEventListener('beforeunload', async function() {
            await trackAnalytics('session_end');
        });

        // Track visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                trackAnalytics('session_end');
            } else {
                // User returned - track as session continuation if recent
                const timeSinceStart = new Date() - sessionStartTime;
                if (timeSinceStart > 30 * 60 * 1000) { // 30 minutes
                    currentSessionId = generateSessionId();
                    sessionStartTime = new Date();
                    trackPageView();
                }
            }
        });
    </script>
</body>
</html>
